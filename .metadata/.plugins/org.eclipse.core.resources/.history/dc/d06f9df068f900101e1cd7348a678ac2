/*
 * Mesh.h
 *
 *  Created on: Jan 24, 2026
 *      Author: 22142
 */

#ifndef INC_MESH_H_
#define INC_MESH_H_

#include "gpio.h"
#include "stm32f1xx.h"
#include "string.h"
#include "LoRa.h"


extern uint32_t lastActivityTime;
extern uint32_t watchdogTimeout;
extern uint8_t radioErrorCount;
extern uint32_t lastResetTime;
extern uint32_t lcg_seed;

void Mesh_reset_watchdog(void);
void Mesh_check_watchdog(void);
void Mesh_hard_reset_radio(void);

uint8_t Mesh_isDuplicate(uint8_t src, uint16_t msg_id);
void Mesh_rememberPacket(uint8_t src, uint16_t msg_id);

uint32_t Mesh_lcg_rand(void);
float Mesh_rand_range(float min, float max);


uint8_t Mesh_check_radio_status(LoRa *radio);
void Mesh_check_radio_health(LoRa *radio);
uint8_t Mesh_wait_for_tx_complete(LoRa *radio);
/**************************************************************************************************************/

										//  LoRa ***IMP*** Functions //

/**************************************************************************************************************/
void Mesh_handle_req_data(
    uint8_t src_id,
    uint16_t msg_id,
    uint8_t self_id,
    char *payloadBuf,
    size_t payloadBufLen
);

uint8_t Mesh_request_registration(
    LoRa *radio,
    uint32_t uid[3],
    int *nodeId,
    char *payloadBuf,
    size_t payloadBufLen
);

#endif /* INC_MESH_H_ */

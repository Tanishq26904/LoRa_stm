#ifndef MESH_LIB_H
#define MESH_LIB_H

#ifdef __cplusplus
extern "C" {
#endif

/* Includes ------------------------------------------------------------------*/
#include <stdint.h>
#include <stdarg.h>
#include "stm32f1xx_hal.h"  // Add HAL for types

/* Forward declaration for LoRa structure */
struct LoRa_setting;
typedef struct LoRa_setting LoRa;

/* Constants -----------------------------------------------------------------*/
#define MESH_VERSION          0x01
#define PKT_REQ_ADDRESS       0x01
#define PKT_ACK_ADDRESS       0x02
#define PKT_REQ_DATA          0x03
#define PKT_SENSOR_DATA       0x04
#define PKT_ACK               0x05
#define PKT_MASTER_ADV        0x06

#define DUP_CACHE_SIZE        16
#define DBG_BUF_SIZE          128

#define MASTER_TIMEOUT_MS     10000
#define ROUTING_WINDOW_MS     30000

#define FLASH_STORAGE_START  0x0800FC00
#define FLASH_MAGIC_NUMBER   0x55AA1234

/* Typedefs ------------------------------------------------------------------*/
typedef struct __attribute__((packed)) {
    uint8_t  version;
    uint8_t  type;
    uint8_t  src;
    uint8_t  dest;
    uint8_t  ttl;
    uint8_t  flags;
    uint16_t msg_id;
    uint8_t payload_len;
} MeshHeader;

typedef struct {
    uint8_t src;
    uint16_t msg_id;
} SeenPacket;

typedef enum {
    PHASE_ROUTING,
    PHASE_REGISTRATION,
    PHASE_NORMAL
} mesh_phase_t;

void printu(const char *msg);

#ifdef __cplusplus
}
#endif

#endif /* MESH_LIB_H */
